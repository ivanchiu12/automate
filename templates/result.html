{% extends 'base.html' %}

{% block title %}Extraction & CRM Results{% endblock %}

{% block content %}
<div class="text-center mb-5">
    <h2>Automation Results</h2>
    <p class="lead">OCR data extracted by the LLM and the corresponding search results from the CRM.</p>
</div>

<!-- LLM Extraction Results -->
<div class="mb-5">
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
            <h4><i class="bi bi-robot"></i> LLM-Extracted Information ({{ records|length }} record{{ 's' if records|length != 1 else '' }})</h4>
        </div>
        <div class="card-body">
            {% if records %}
                {% for record in records %}
                    <div class="record-item {% if loop.index > 1 %}border-top pt-4 mt-4{% endif %}">
                        {% if records|length > 1 %}
                            <h5 class="text-primary mb-3">Record {{ loop.index }}</h5>
                        {% endif %}
                        <div class="row">
                            {% for key, value in record.items() %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="d-flex">
                                        <strong class="text-capitalize me-2">{{ key.replace('_', ' ') }}:</strong>
                                        <span>{{ value }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-danger">No information could be extracted from the file.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- CRM Search Results -->
<div class="mb-5">
    <div class="card shadow-sm">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h4><i class="bi bi-journal-text"></i> CRM Search Results ({{ all_crm_rows|length }} records found)</h4>
            {% if all_crm_rows %}
            <div>
                <button class="btn btn-light btn-sm" onclick="exportToCSV()">
                    <i class="bi bi-download"></i> Export CSV
                </button>
                <button class="btn btn-light btn-sm" onclick="exportToExcel()">
                    <i class="bi bi-file-earmark-excel"></i> Export Excel
                </button>
            </div>
            {% endif %}
        </div>
        <div class="card-body p-0">
            {% if all_crm_rows %}
                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-bordered table-sm table-hover mb-0" id="crmTable">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th class="text-nowrap" style="min-width: 80px;">Source</th>
                                {% for key in all_crm_rows[0].keys() %}
                                    {% if not key.startswith('_') %}
                                        <th class="text-nowrap" style="min-width: 120px; max-width: 200px;">
                                            {{ key.replace('_', ' ').title() }}
                                        </th>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                        {% for row in all_crm_rows %}
                            <tr>
                                <td class="text-nowrap fw-bold" style="background-color: #f8f9fa;">
                                    Record {{ row.get('_record_index', '?') }}<br>
                                    <small class="text-muted">{{ row.get('_source_invoice', 'N/A') }}</small>
                                </td>
                                {% for key, value in row.items() %}
                                    {% if not key.startswith('_') %}
                                        <td class="text-nowrap" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="{{ value }}">
                                            {{ value }}
                                        </td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="p-4 text-center">
                    <p class="text-warning">No matching records found in the CRM for the processed invoices.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="text-center mt-5">
    <a href="{{ url_for('index') }}" class="btn btn-secondary btn-lg">
        <i class="bi bi-arrow-left-circle"></i> Run Another
    </a>
</div>

<!-- CRM Script Logs -->
{% if logs %}
<div class="mt-5">
    <div class="accordion" id="logsAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="logsHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#logsCollapse" aria-expanded="false" aria-controls="logsCollapse">
                    <i class="bi bi-terminal"></i> View CRM Script Logs
                </button>
            </h2>
            <div id="logsCollapse" class="accordion-collapse collapse" aria-labelledby="logsHeading">
                <div class="accordion-body">
                    <pre class="bg-light p-3 rounded border">{{ logs }}</pre>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
function exportToCSV() {
    const table = document.getElementById('crmTable');
    const rows = table.querySelectorAll('tr');
    let csv = [];
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cols = row.querySelectorAll('td, th');
        const rowData = [];
        
        for (let j = 0; j < cols.length; j++) {
            let cell = cols[j].textContent.trim();
            cell = cell.replace(/"/g, '""');
            rowData.push('"' + cell + '"');
        }
        
        csv.push(rowData.join(','));
    }
    
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'crm_results.csv';
    link.click();
}

function exportToExcel() {
    // For Excel export, we'll use a simple CSV approach that Excel can open
    exportToCSV();
}
</script>

<style>
.sticky-top {
    position: sticky;
    top: 0;
    z-index: 1020;
}

#crmTable th {
    background-color: #343a40 !important;
    color: white !important;
    font-weight: bold;
    text-align: center;
    vertical-align: middle;
}

#crmTable td {
    vertical-align: middle;
    font-size: 0.9rem;
}

#crmTable tbody tr:hover {
    background-color: #f8f9fa;
}

.table-responsive::-webkit-scrollbar {
    height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>
{% endblock %} 