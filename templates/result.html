{% extends 'base.html' %}

{% block title %}Extraction & CRM Results{% endblock %}

{% block content %}
<div class="text-center mb-5">
    <h2>Automation Results</h2>
    <p class="lead">OCR data extracted by the LLM and the corresponding search results from the CRM.</p>
    {% if annotated_pdf %}
    <div class="alert alert-success">
        <i class="bi bi-check-circle"></i> Annotated PDF with CRM results has been generated and is available for download below.
    </div>
    {% endif %}
</div>

<!-- LLM Extraction Results -->
<div class="mb-5">
    <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
            <h4><i class="bi bi-robot"></i> LLM-Extracted Information ({{ records|length }} record{{ 's' if records|length != 1 else '' }})</h4>
        </div>
        <div class="card-body">
            {% if records %}
                {% for record in records %}
                    <div class="record-item {% if loop.index > 1 %}border-top pt-4 mt-4{% endif %}">
                        {% if records|length > 1 %}
                            <h5 class="text-primary mb-3">Record {{ loop.index }}</h5>
                        {% endif %}
                        <div class="row">
                            {% for key, value in record.items() %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="d-flex">
                                        <strong class="text-capitalize me-2">{{ key.replace('_', ' ') }}:</strong>
                                        <span>{{ value }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-danger">No information could be extracted from the file.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- CRM Search Results -->
<div class="mb-5">
    <div class="card shadow-sm">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h4><i class="bi bi-journal-text"></i> CRM Search Results ({{ all_crm_rows|length }} records found)</h4>
            {% if all_crm_rows %}
            <div>
                <button class="btn btn-success btn-sm" onclick="saveChanges()">
                    <i class="bi bi-check-circle"></i> Save Changes
                </button>
                <button class="btn btn-primary btn-sm" onclick="generateAnnotatedPDF()">
                    <i class="bi bi-file-earmark-pdf-fill"></i> Generate Annotated PDF
                </button>
                <button class="btn btn-light btn-sm" onclick="exportToCSV()">
                    <i class="bi bi-download"></i> Export CSV
                </button>
                <button class="btn btn-light btn-sm" onclick="exportToExcel()">
                    <i class="bi bi-file-earmark-excel"></i> Export Excel
                </button>
            </div>
            {% endif %}
        </div>
        <div class="card-body p-0">
            {% if all_crm_rows %}
                <div class="mb-2 text-muted small px-3 py-2">
                    <i class="bi bi-info-circle"></i> 
                    Scroll horizontally to view all columns. Drag column borders to resize.
                </div>
                <div class="table-responsive" style="max-height: 80vh; overflow-x: auto; overflow-y: auto;">
                    <table class="table table-bordered table-sm table-hover mb-0" id="crmTable">
                        <thead class="table-dark">
                            <tr>
                                <!-- Define consistent column order -->
                                <th class="text-nowrap resizable-header" style="min-width: 80px; position: relative;">
                                    Page
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 120px; position: relative;">
                                    Source
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 120px; position: relative;">
                                    Opened
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 150px; position: relative;">
                                    Parent Company Name
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 150px; position: relative;">
                                    Premises Name
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 200px; position: relative;">
                                    Premises Address
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 100px; position: relative;">
                                    Salutation
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 120px; position: relative;">
                                    Contact Name
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 120px; position: relative;">
                                    Title
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 150px; position: relative;">
                                    Business E-Mail
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 120px; position: relative;">
                                    Phone Number
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 120px; position: relative;">
                                    Licence Category
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 120px; position: relative;">
                                    Expected Closed
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 100px; position: relative;">
                                    Stage
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 150px; position: relative;">
                                    Payment Received Date
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 120px; position: relative;">
                                    Invoice No
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 120px; position: relative;">
                                    Net Licence Fee
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 100px; position: relative;">
                                    Territory
                                    <div class="resize-handle"></div>
                                </th>
                                <th class="text-nowrap resizable-header" style="min-width: 120px; position: relative;">
                                    Assigned To
                                    <div class="resize-handle"></div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                        {% set column_order = ['Page', 'Source', 'Opened', 'Parent Company Name', 'Premises Name', 'Premises Address', 'Salutation', 'Contact Name', 'Title', 'Business E-Mail', 'Phone Number', 'Licence Category', 'Expected Closed', 'Stage', 'Payment Received Date', 'Invoice No', 'Net Licence Fee', 'Territory', 'Assigned To'] %}
                        {% for row in all_crm_rows %}
                            <tr data-page-index="{{ row.get('_page_index', 0) }}">
                                {% for column in column_order %}
                                    <td style="max-width: 200px; position: relative;" {% if column == 'Page' %}class="page-column"{% endif %}>
                                        {% set value = row.get(column, '') %}
                                        {% if column == 'Page' %}
                                            <span class="fw-bold text-primary">{{ value }}</span>
                                        {% else %}
                                            <input type="text" 
                                                   class="form-control form-control-sm editable-cell border-0 bg-transparent" 
                                                   value="{{ value }}" 
                                                   data-field="{{ column }}" 
                                                   data-row-id="{{ loop.index0 }}"
                                                   style="padding: 2px 4px; min-height: 28px;"
                                                   placeholder="Enter {{ column.replace('_', ' ').lower() }}">
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="p-4 text-center">
                    <p class="text-warning">No matching records found in the CRM for the processed invoices.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="text-center mt-5">
    <a href="{{ url_for('index') }}" class="btn btn-secondary btn-lg">
        <i class="bi bi-arrow-left-circle"></i> Run Another
    </a>
</div>

<!-- CRM Script Logs -->
{% if logs %}
<div class="mt-5">
    <div class="accordion" id="logsAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="logsHeading">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#logsCollapse" aria-expanded="false" aria-controls="logsCollapse">
                    <i class="bi bi-terminal"></i> View CRM Script Logs
                </button>
            </h2>
            <div id="logsCollapse" class="accordion-collapse collapse" aria-labelledby="logsHeading">
                <div class="accordion-body">
                    <pre class="bg-light p-3 rounded border">{{ logs }}</pre>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
// Handle editable cells and column resizing
document.addEventListener('DOMContentLoaded', function() {
    const editableCells = document.querySelectorAll('.editable-cell');
    
    editableCells.forEach(cell => {
        // Add visual feedback on focus
        cell.addEventListener('focus', function() {
            this.style.backgroundColor = '#fff3cd';
            this.style.border = '1px solid #ffeaa7';
        });
        
        cell.addEventListener('blur', function() {
            this.style.backgroundColor = 'transparent';
            this.style.border = '0';
        });
        
        // Auto-resize input based on content
        cell.addEventListener('input', function() {
            const tempSpan = document.createElement('span');
            tempSpan.style.visibility = 'hidden';
            tempSpan.style.position = 'absolute';
            tempSpan.style.whiteSpace = 'nowrap';
            tempSpan.style.font = window.getComputedStyle(this).font;
            tempSpan.textContent = this.value || this.placeholder;
            document.body.appendChild(tempSpan);
            
            const newWidth = Math.max(100, tempSpan.offsetWidth + 20);
            this.style.width = newWidth + 'px';
            
            document.body.removeChild(tempSpan);
        });
    });
    
    // Initialize column resizing
    initColumnResizing();
});

function initColumnResizing() {
    const table = document.getElementById('crmTable');
    const headers = table.querySelectorAll('.resizable-header');
    
    headers.forEach((header, index) => {
        const resizeHandle = header.querySelector('.resize-handle');
        let isResizing = false;
        let startX = 0;
        let startWidth = 0;
        
        resizeHandle.addEventListener('mousedown', function(e) {
            isResizing = true;
            startX = e.clientX;
            startWidth = parseInt(document.defaultView.getComputedStyle(header).width, 10);
            
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
            
            // Prevent text selection during resize
            e.preventDefault();
        });
        
        function doResize(e) {
            if (!isResizing) return;
            
            const width = startWidth + e.clientX - startX;
            const minWidth = 80; // Minimum column width
            const newWidth = Math.max(minWidth, width);
            
            header.style.width = newWidth + 'px';
            
            // Also update corresponding cells in the column
            const columnCells = table.querySelectorAll(`tbody tr td:nth-child(${index + 1})`);
            columnCells.forEach(cell => {
                cell.style.width = newWidth + 'px';
                cell.style.maxWidth = newWidth + 'px';
            });
        }
        
        function stopResize() {
            isResizing = false;
            document.removeEventListener('mousemove', doResize);
            document.removeEventListener('mouseup', stopResize);
        }
    });
}

function exportToCSV() {
    const table = document.getElementById('crmTable');
    const rows = table.querySelectorAll('tr');
    let csv = [];
    
    // Define column headers in consistent order
    const headers = ['Page', 'Source', 'Opened', 'Parent Company Name', 'Premises Name', 
                    'Premises Address', 'Salutation', 'Contact Name', 'Title', 'Business E-Mail', 
                    'Phone Number', 'Licence Category', 'Expected Closed', 'Stage', 
                    'Payment Received Date', 'Invoice No', 'Net Licence Fee', 'Territory', 'Assigned To'];
    
    // Add header row
    csv.push(headers.map(h => '"' + h + '"').join(','));
    
    // Add data rows
    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const cols = row.querySelectorAll('td');
        const rowData = [];
        
        for (let j = 0; j < cols.length; j++) {
            const input = cols[j].querySelector('input.editable-cell');
            const span = cols[j].querySelector('span');
            let cellValue = '';
            
            if (input) {
                cellValue = input.value.trim();
            } else if (span) {
                cellValue = span.textContent.trim();
            } else {
                cellValue = cols[j].textContent.trim();
            }
            
            cellValue = cellValue.replace(/"/g, '""');
            rowData.push('"' + cellValue + '"');
        }
        
        csv.push(rowData.join(','));
    }
    
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'crm_results.csv';
    link.click();
}

function exportToExcel() {
    // For Excel export, we'll use a simple CSV approach that Excel can open
    exportToCSV();
}

// Add save functionality
function saveChanges() {
    const editableCells = document.querySelectorAll('.editable-cell');
    const changes = [];
    
    editableCells.forEach(cell => {
        const rowId = cell.getAttribute('data-row-id');
        const field = cell.getAttribute('data-field');
        const value = cell.value;
        
        changes.push({
            rowId: rowId,
            field: field,
            value: value
        });
    });
    
    console.log('Changes to save:', changes);
    // Here you could send the changes to the backend via AJAX if needed
    alert('Changes saved locally! Export CSV/Excel to save permanently.');
}

// Generate annotated PDF with current table data
function generateAnnotatedPDF() {
    const editableCells = document.querySelectorAll('.editable-cell');
    const tableData = [];
    
    // Collect current table data
    const table = document.getElementById('crmTable');
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach((row, rowIndex) => {
        const rowData = {};
        const cells = row.querySelectorAll('td');
        
        cells.forEach((cell, cellIndex) => {
            const input = cell.querySelector('input.editable-cell');
            const span = cell.querySelector('span');
            let cellValue = '';
            let fieldName = '';
            
            if (input) {
                cellValue = input.value.trim();
                fieldName = input.getAttribute('data-field');
            } else if (span) {
                cellValue = span.textContent.trim();
                fieldName = 'Page'; // This is the page column
            } else {
                cellValue = cell.textContent.trim();
            }
            
            if (fieldName) {
                rowData[fieldName] = cellValue;
            }
        });
        
        // Get page index from row attribute
        const pageIndex = row.getAttribute('data-page-index');
        if (pageIndex !== null) {
            rowData['_page_index'] = parseInt(pageIndex);
        }
        
        tableData.push(rowData);
    });
    
    // Show PDF-specific loading animation
    showPDFLoading();
    
    // Show loading state on button too
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating PDF...';
    button.disabled = true;
    
    // Send data to backend
    fetch('/generate_annotated_pdf', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            tableData: tableData
        })
    })
    .then(response => response.json())
    .then(data => {
        setTimeout(() => {
            hidePDFLoading();
            button.innerHTML = originalText;
            button.disabled = false;
            
            if (data.success) {
                // Create download link
                const link = document.createElement('a');
                link.href = '/serve_pdf/' + data.filename;
                link.download = data.filename;
                link.click();
                
                // Show success message
                showSuccessToast('Annotated PDF generated successfully!');
            } else {
                showErrorToast('Error generating PDF: ' + (data.error || 'Unknown error'));
            }
        }, 1000);
    })
    .catch(error => {
        hidePDFLoading();
        button.innerHTML = originalText;
        button.disabled = false;
        console.error('Error:', error);
        showErrorToast('Error generating PDF: ' + error.message);
    });
}

// PDF-specific loading functions
function showPDFLoading() {
    // Create PDF loading overlay if it doesn't exist
    let pdfOverlay = document.getElementById('pdfLoadingOverlay');
    if (!pdfOverlay) {
        pdfOverlay = document.createElement('div');
        pdfOverlay.id = 'pdfLoadingOverlay';
        pdfOverlay.className = 'pdf-loading-overlay';
        pdfOverlay.innerHTML = `
            <div class="pdf-loading-content">
                <div class="pdf-spinner">
                    <div class="pdf-spinner-inner"></div>
                </div>
                <h4 class="pdf-loading-title">Generating PDF</h4>
                <p class="pdf-loading-message">Please wait while we create your annotated PDF...</p>
                <div class="pdf-progress-dots">
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
            </div>
        `;
        document.body.appendChild(pdfOverlay);
    }
    pdfOverlay.style.display = 'flex';
}

function hidePDFLoading() {
    const pdfOverlay = document.getElementById('pdfLoadingOverlay');
    if (pdfOverlay) {
        pdfOverlay.style.display = 'none';
    }
}

function showSuccessToast(message) {
    showToast(message, 'success');
}

function showErrorToast(message) {
    showToast(message, 'error');
}

function showToast(message, type) {
    // Create toast if it doesn't exist
    let toast = document.getElementById('toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        toast.className = 'toast-notification';
        document.body.appendChild(toast);
    }
    
    toast.className = `toast-notification toast-${type} show`;
    toast.innerHTML = `
        <i class="bi bi-${type === 'success' ? 'check-circle-fill' : 'exclamation-triangle-fill'}"></i>
        <span>${message}</span>
    `;
    
    // Auto-hide after 4 seconds
    setTimeout(() => {
        toast.classList.remove('show');
    }, 4000);
}
</script>

<style>
#crmTable th {
    background-color: #343a40 !important;
    color: white !important;
    font-weight: bold;
    text-align: center;
    vertical-align: middle;
}

#crmTable td {
    vertical-align: middle;
    font-size: 0.9rem;
    padding: 4px 8px;
}

#crmTable tbody tr:hover {
    background-color: #f8f9fa;
}

.editable-cell {
    transition: all 0.2s ease-in-out;
    border-radius: 3px;
}

.editable-cell:focus {
    box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.25) !important;
    outline: none !important;
}

.editable-cell:hover {
    background-color: #f8f9fa !important;
    border: 1px solid #dee2e6 !important;
}

/* Style for page column */
.page-column {
    background-color: #e3f2fd !important;
    font-weight: bold;
    text-align: center;
}

/* Empty row styling for pages without results */
tr[data-page-index] td {
    border-top: 2px solid #dee2e6;
}

tr[data-page-index="0"] td {
    border-top: none;
}

/* Column resizing styles */
.resizable-header {
    position: relative;
    user-select: none;
}

.resize-handle {
    position: absolute;
    top: 0;
    right: 0;
    width: 5px;
    height: 100%;
    background: transparent;
    cursor: col-resize;
    z-index: 10;
}

.resize-handle:hover {
    background: rgba(255, 255, 255, 0.3);
}

.resize-handle:active {
    background: rgba(255, 255, 255, 0.5);
}

/* Ensure table layout is fixed for proper resizing */
#crmTable {
    table-layout: fixed;
    width: max-content; /* Allow table to expand beyond container */
    min-width: 1800px; /* Minimum width to ensure all columns are visible */
}

#crmTable th,
#crmTable td {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    position: relative;
}

/* Improve table container scrolling */
.table-responsive {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

/* Sticky header for better UX during vertical scroll */
#crmTable thead th {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: #343a40 !important;
}

/* Improve scrollbar appearance */
.table-responsive::-webkit-scrollbar {
    height: 12px;
    width: 12px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* Ensure inputs don't break table layout */
.editable-cell {
    min-width: 80px;
    box-sizing: border-box;
}

/* PDF Loading Animation Styles */
.pdf-loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    backdrop-filter: blur(3px);
}

.pdf-loading-content {
    background: white;
    padding: 30px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    max-width: 350px;
    width: 90%;
}

.pdf-spinner {
    width: 60px;
    height: 60px;
    margin: 0 auto 20px;
    position: relative;
    border: 4px solid #f3f3f3;
    border-radius: 50%;
    border-top: 4px solid #dc3545;
    animation: pdfSpin 1s linear infinite;
}

.pdf-spinner-inner {
    width: 40px;
    height: 40px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border: 3px solid transparent;
    border-radius: 50%;
    border-bottom: 3px solid #007bff;
    animation: pdfSpinReverse 0.8s linear infinite;
}

@keyframes pdfSpin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes pdfSpinReverse {
    0% { transform: translate(-50%, -50%) rotate(360deg); }
    100% { transform: translate(-50%, -50%) rotate(0deg); }
}

.pdf-loading-title {
    color: #333;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 1.3rem;
}

.pdf-loading-message {
    color: #666;
    margin-bottom: 20px;
    font-size: 0.95rem;
}

.pdf-progress-dots {
    display: flex;
    justify-content: center;
    gap: 8px;
}

.pdf-progress-dots .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #007bff;
    animation: dotPulse 1.4s ease-in-out infinite both;
}

.pdf-progress-dots .dot:nth-child(1) {
    animation-delay: -0.32s;
}

.pdf-progress-dots .dot:nth-child(2) {
    animation-delay: -0.16s;
}

.pdf-progress-dots .dot:nth-child(3) {
    animation-delay: 0s;
}

@keyframes dotPulse {
    0%, 80%, 100% {
        transform: scale(0.6);
        opacity: 0.5;
    }
    40% {
        transform: scale(1);
        opacity: 1;
    }
}

/* Toast Notification Styles */
.toast-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    border-radius: 8px;
    color: white;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 10001;
    transform: translateX(400px);
    transition: transform 0.3s ease-in-out;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

.toast-notification.show {
    transform: translateX(0);
}

.toast-notification.toast-success {
    background: linear-gradient(135deg, #28a745, #20c997);
}

.toast-notification.toast-error {
    background: linear-gradient(135deg, #dc3545, #fd7e14);
}

.toast-notification i {
    font-size: 1.2rem;
}

@media (max-width: 768px) {
    .pdf-loading-content {
        padding: 20px;
        margin: 20px;
    }
    
    .toast-notification {
        right: 10px;
        left: 10px;
        transform: translateY(-100px);
    }
    
    .toast-notification.show {
        transform: translateY(0);
    }
}
</style>
{% endblock %} 